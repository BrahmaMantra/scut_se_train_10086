# Spark 离线分析模块

根据你提供的三个 Spark 代码文件内容，结合上述功能需求，分析如下：

## CalUserBitmapIndex.scala

作用：

为每个用户（IMSI）分配唯一的 BITMAP_ID，并写入 ClickHouse 的 USER_INDEX 表。

对应需求：

这是后续所有区域、画像分析的基础数据准备环节。它不直接实现统计分析功能，但为后续通过位图高效统计和交集运算提供了索引基础。

关联需求：

为“指定区域内画像用户数统计分析”、“指定区域内画像用户明细分析”、“指定区域内用户画像分布统计分析”提供用户唯一标识的基础。

## CalRegionUserStay.scala

作用：

将基站信令数据（XDR）、区域-基站关系、用户位图索引进行关联，统计每个区域每小时内出现过的用户集合（以 RoaringBitmap 存储），写入
ClickHouse 的 REGION_ID_IMSI_BITMAP 表。

对应需求：

主要支撑“指定区域内画像用户数统计分析”与“指定区域内用户画像分布统计分析”。
通过区域ID和时间，可以快速查询该区域该时段的用户集合（位图），再与画像位图做交集，得到各画像特征的用户数或分布。
也为“指定区域内画像用户明细分析”提供区域-用户的基础数据。

## CalUserPersonBitMap.scala

作用：

将用户基础信息（如性别、年龄等画像特征）与用户位图索引关联，生成各画像特征对应的用户集合位图，写入 ClickHouse 的
TA_PORTRAIT_IMSI_BITMAP 表。

对应需求：

主要支撑“指定区域内画像用户数统计分析”、“指定区域内用户画像分布统计分析”。
通过画像特征（如性别、年龄段）可直接获得该特征下的用户位图，与区域用户位图做交集，快速统计数量或分布。
也为“指定区域内画像用户明细分析”提供画像-用户的基础数据。

总结对应关系：

- CalUserBitmapIndex.scala：为所有需求提供用户唯一标识基础。
- CalRegionUserStay.scala：为区域+时间维度下的用户集合统计提供数据，支撑区域内用户数、分布等分析。
- CalUserPersonBitMap.scala：为画像特征下的用户集合统计提供数据，支撑画像用户数、分布等分析。

三者结合，正好覆盖了你列出的所有离线统计分析类需求。